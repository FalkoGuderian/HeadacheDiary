<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêªHeadache Diary</title>
  <link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAP///8A" rel="icon" type="image/x-icon">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script src="js/utils.js"></script>
  <script type="text/babel">
    // AI Prompts Configuration
    const AI_CONFIG = {
      model: 'x-ai/grok-4-fast',
      temperature: 0.7,
      maxTokens: {
        chatbotParsing: 500,
        headacheAnalysis: 2000
      }
    };

    const AI_API_ENDPOINT = 'https://openrouter.ai/api/v1/chat/completions';

    function getChatbotParsingPrompt(userInput, questions, currentStep) {
      const currentQuestion = questions[currentStep];
      const today = new Date().toISOString().split('T')[0];
      return `You are an assistant that analyzes user inputs and converts them into structured data for a headache diary. Break down the input into the following fields: ${currentQuestion.fields.join(', ')}. Return the answer in JSON format, e.g. { "field1": "value1", "field2": "value2" }. If a field cannot be clearly filled, leave it empty ("").

IMPORTANT INSTRUCTIONS:
- For date fields: Convert relative dates like "today", "yesterday", "tomorrow" to YYYY-MM-DD format. Also handle European date formats like "12.11.2025" ‚Üí "2025-11-12". Today's date is ${today}.
- For time fields: Convert times like "2pm", "2:00 PM", "14:00" to 24-hour format (HH:MM). For example: "2pm" becomes "14:00", "9am" becomes "09:00".
- For duration fields: Extract only the numeric value in minutes. For example: "10 minutes" or "10min" becomes 10, "2 hours" becomes 120.
- Handle both natural language and structured input (e.g., "Date 12.11.2025 Time 14:00 Duration 10 Intensity Mild").
- Only extract information that is clearly mentioned in the user input.

User input: "${userInput}"

Fields: ${currentQuestion.fields.join(', ')}

Respond only with the JSON object, without additional text.`;
    }

    function getHeadacheAnalysisPrompt(entries) {
      const historyText = entries.map((entry, index) => {
        return `Entry ${index + 1}:
- Date: ${entry.date}
- Time: ${entry.time}
- Duration: ${entry.duration || 'N/A'} minutes
- Intensity: ${entry.intensity || 'N/A'}
- Accompanying symptoms: ${entry.symptoms || 'N/A'}
- Stress situation: ${entry.stressSituation || 'N/A'}
- Interaction with family: ${entry.familyInteraction || 'N/A'}
- Stress signs: ${entry.stressSigns || 'N/A'}
- Sleep hours: ${entry.sleepHours || 'N/A'}
- Sleep quality: ${entry.sleepQuality || 'N/A'}
- Daily activity: ${entry.dailyActivity || 'N/A'}
- Chocolate amount: ${entry.chocolateAmount || 'N/A'}
- Cheese amount: ${entry.cheeseAmount || 'N/A'}
- Other foods: ${entry.otherFoods || 'N/A'}
- Water intake: ${entry.waterIntake || 'N/A'}
- Dehydration signs: ${entry.dehydrationSigns || 'N/A'}
- Snacks: ${entry.snacks || 'N/A'}
- Meal routine: ${entry.mealRoutine || 'N/A'}
- Screen time: ${entry.screenTime || 'N/A'}
- Allergies: ${entry.allergies || 'N/A'}
- Medical tests: ${entry.medicalTests || 'N/A'}
- Environmental changes: ${entry.environmentChanges || 'N/A'}\n`;
      }).join('\n');

      return `You are a medical expert for headaches. Analyze the following history of headache entries from a patient. Identify the most likely cause(s) for the headaches based on the data (e.g. stress, diet, sleep, dehydration, environmental changes). Provide concrete measures to prevent the headaches based on the identified causes. The answer should be clear, concise, and formulated in English. Return the answer in the following format:

**Most Likely Cause(s):**
- [Cause 1]
- [Cause 2, if applicable]

**Recommended Measures:**
- [Measure 1]
- [Measure 2]
- ...

**Note:** If the data is insufficient to identify a specific cause, provide the most likely possibilities and recommend general measures as well as further investigations.

**History:**
${historyText}`;
    }

    const { useState, useEffect, useRef } = React;

    // Chatbot Component
    const Chatbot = ({ formData, setFormData, apiKey, setChatbotOpen, setChatbotError }) => {
      // Load saved chatbot state from localStorage
      const loadSavedState = () => {
        try {
          const saved = localStorage.getItem('chatbotState');
          return saved ? JSON.parse(saved) : null;
        } catch (e) {
          return null;
        }
      };

      const savedState = loadSavedState();
      const [messages, setMessages] = useState(savedState?.messages || []);
      const [userInput, setUserInput] = useState('');
      const [currentStep, setCurrentStep] = useState(savedState?.currentStep || 0);
      const [collectedData, setCollectedData] = useState(savedState?.collectedData || {});

      // Question structure in groups
      const questions = [
        {
          prompt: "When did you have the headache? Please provide date (e.g. 2025-05-18), time (e.g. 14:30), duration in minutes, and intensity (mild, moderate, or severe).",
          fields: ['date', 'time', 'duration', 'intensity']
        },
        {
          prompt: "What accompanying symptoms did you have (e.g. nausea, light sensitivity)? Was there a stress situation (e.g. argument with brother)? How was the interaction with the family (e.g. reaction to family situation)? Were there stress signs (e.g. anxiety, overload)?",
          fields: ['symptoms', 'stressSituation', 'familyInteraction', 'stressSigns']
        },
        {
          prompt: "How many hours did you sleep? How was the sleep quality (e.g. restless, frequent waking)? What daily activity did you perform (e.g. outdoor exercise)?",
          fields: ['sleepHours', 'sleepQuality', 'dailyActivity']
        },
        {
          prompt: "How much chocolate (e.g. number of cookies) and cheese did you eat? What other foods did you consume? How much water did you drink (e.g. glasses per day)? Were there dehydration signs (e.g. dark urine)? What snacks did you eat in the evening? How was your meal routine (e.g. fixed or unstructured)?",
          fields: ['chocolateAmount', 'cheeseAmount', 'otherFoods', 'waterIntake', 'dehydrationSigns', 'snacks', 'mealRoutine']
        },
        {
          prompt: "How much screen time did you have (hours per day)? Do you have allergies or intolerances? Were there medical tests (e.g. blood tests)? Were there environmental changes (e.g. new kindergarten)?",
          fields: ['screenTime', 'allergies', 'medicalTests', 'environmentChanges']
        }
      ];

      // Startnachricht
      useEffect(() => {
        if (currentStep === 0) {
          setMessages([{ text: questions[0].prompt, isBot: true }]);
        }
      }, []);

      const handleUserInput = async (e) => {
        e.preventDefault();
        if (!userInput.trim()) return;

        // F√ºge Benutzernachricht hinzu
        setMessages([...messages, { text: userInput, isBot: false }]);
        const currentQuestion = questions[currentStep];

        // Sende Eingabe an OpenRouter, um Antworten in Felder aufzuteilen
        try {
          const response = await fetch(window.AI_API_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
              'HTTP-Referer': window.location.origin,
              'X-Title': 'Headache Diary'
            },
            body: JSON.stringify({
              model: AI_CONFIG.model,
              messages: [
                {
                  role: 'user',
                  content: getChatbotParsingPrompt(userInput, questions, currentStep)
                }
              ],
              max_tokens: AI_CONFIG.maxTokens.chatbotParsing,
              temperature: AI_CONFIG.temperature
            })
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          const parsedData = JSON.parse(data.choices[0].message.content);

          // Aktualisiere gesammelte Daten
          const newCollectedData = { ...collectedData, ...parsedData };
          setCollectedData(newCollectedData);

          // Pr√ºfe, ob alle Felder der aktuellen Frage ausgef√ºllt wurden
          const currentQuestionFields = questions[currentStep].fields;
          const allFieldsFilled = currentQuestionFields.every(field => parsedData[field] && parsedData[field] !== "");

          if (allFieldsFilled && currentStep < questions.length - 1) {
            // Alle Felder ausgef√ºllt, automatisch zur n√§chsten Frage
            setCurrentStep(currentStep + 1);
            setMessages([...messages, { text: userInput, isBot: false }, { text: questions[currentStep + 1].prompt, isBot: true }]);
          } else {
            // Nicht alle Felder ausgef√ºllt oder letzte Frage, Optionen anzeigen
            setMessages([...messages, { text: userInput, isBot: false }, {
              text: `Data collected so far: ${Object.keys(newCollectedData).length > 0 ? Object.keys(newCollectedData).join(', ') : 'none'}. What would you like to do?`,
              isBot: true,
              isOptions: true
            }]);
          }
        } catch (error) {
          setChatbotError(`Error during processing: ${error.message}`);
        }

        setUserInput('');
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
          <div className="bg-white p-6 rounded-lg max-w-lg w-full max-h-[80vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-semibold">Form Assistant: New Entry</h3>
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    // Save current data to form and chatbot state to localStorage
                    setFormData({ ...formData, ...collectedData });
                    const chatbotState = {
                      messages,
                      currentStep,
                      collectedData
                    };
                    localStorage.setItem('chatbotState', JSON.stringify(chatbotState));
                  }}
                  className="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600"
                  title="Save progress to continue later"
                >
                  üíæ Save
                </button>
                <button
                  onClick={() => {
                    // Restart chatbot conversation
                    setMessages([{ text: questions[0].prompt, isBot: true }]);
                    setCurrentStep(0);
                    setCollectedData({});
                    localStorage.removeItem('chatbotState');
                  }}
                  className="bg-orange-500 text-white px-3 py-1 rounded text-sm hover:bg-orange-600"
                  title="Restart conversation from beginning"
                >
                  üîÑ Restart
                </button>
              </div>
            </div>
            <div className="space-y-4">
              {messages.map((msg, index) => (
                <div key={index}>
                  <div className={`p-2 rounded ${msg.isBot ? 'bg-blue-100' : 'bg-gray-100 text-right'}`}>
                    {msg.text}
                  </div>
                  {msg.isOptions && (
                    <div className="flex flex-wrap gap-2 mt-2 ml-2">
                      {currentStep < questions.length - 1 && (
                        <button
                          onClick={() => {
                            setCurrentStep(prev => {
                              const nextStep = prev + 1;
                              setMessages(prevMsgs => [...prevMsgs, { text: questions[nextStep].prompt, isBot: true }]);
                              return nextStep;
                            });
                          }}
                          className="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600"
                        >
                          Continue to next question
                        </button>
                      )}
                      <button
                        onClick={() => {
                          setFormData({ ...formData, ...collectedData });
                          setChatbotOpen(false);
                          setMessages([]);
                          setCurrentStep(0);
                          setCollectedData({});
                          localStorage.removeItem('chatbotState'); // Clear saved state
                        }}
                        className="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600"
                      >
                        Save and finish
                      </button>
                      <button
                        onClick={() => {
                          // Save chatbot state to localStorage
                          const chatbotState = {
                            messages,
                            currentStep,
                            collectedData
                          };
                          localStorage.setItem('chatbotState', JSON.stringify(chatbotState));

                          setFormData({ ...formData, ...collectedData });
                          setChatbotOpen(false);
                        }}
                        className="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600"
                      >
                        Save and continue later
                      </button>
                    </div>
                  )}
                </div>
              ))}
            </div>
            <form onSubmit={handleUserInput} className="mt-4">
              <input
                type="text"
                value={userInput}
                onChange={(e) => setUserInput(e.target.value)}
                className="w-full p-2 border rounded"
                placeholder="Your answer..."
              />
              <div className="flex space-x-2 mt-2">
                <button
                  type="submit"
                  className="bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
                >
                  Send answer
                </button>
                <button
                  type="button"
                  onClick={() => setChatbotOpen(false)}
                  className="bg-gray-500 text-white p-2 rounded hover:bg-gray-600"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Main HeadacheDiary Component
    const HeadacheDiary = () => {
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);
      const [chatbotOpen, setChatbotOpen] = useState(false);
      const [chatbotError, setChatbotError] = useState('');

      const getCurrentDate = () => {
        const now = new Date();
        return now.toISOString().split('T')[0];
      };

      const getCurrentTime = () => {
        const now = new Date();
        return now.toTimeString().slice(0, 5);
      };

      const [entries, setEntries] = useState([]);
      const [formData, setFormData] = useState({
        date: getCurrentDate(),
        time: getCurrentTime(),
        duration: '',
        intensity: '',
        symptoms: '',
        stressSituation: '',
        familyInteraction: '',
        stressSigns: '',
        sleepHours: '',
        sleepQuality: '',
        dailyActivity: '',
        chocolateAmount: '',
        cheeseAmount: '',
        otherFoods: '',
        waterIntake: '',
        dehydrationSigns: '',
        snacks: '',
        mealRoutine: '',
        screenTime: '',
        allergies: '',
        medicalTests: '',
        environmentChanges: ''
      });
      const [selectedEntry, setSelectedEntry] = useState(null);
      const [apiKey, setApiKey] = useState('');
      const [analysisResult, setAnalysisResult] = useState('');
      const [analysisError, setAnalysisError] = useState('');

      useEffect(() => {
        const savedEntries = JSON.parse(localStorage.getItem('headacheEntries') || '[]');
        setEntries(savedEntries);
      }, []);

      useEffect(() => {
        localStorage.setItem('headacheEntries', JSON.stringify(entries));
      }, [entries]);

      useEffect(() => {
        if (chartRef.current) {
          const ctx = chartRef.current.getContext('2d');
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
          }
          const intensityMap = {
            'mild': 0,
            'moderate': 1,
            'severe': 2
          };
          const data = entries.map(entry => ({
            x: `${entry.date} ${entry.time}`,
            y: intensityMap[entry.intensity?.toLowerCase()] || 0,
            entry: entry
          }));
          chartInstanceRef.current = new Chart(ctx, {
            type: 'line',
            data: {
              datasets: [{
                label: 'Headache Intensity',
                data: data,
                borderColor: '#3b82f6',
                backgroundColor: '#3b82f6',
                tension: 0.1,
                pointRadius: 5,
                pointHoverRadius: 8
              }]
            },
            options: {
              scales: {
                x: {
                  type: 'time',
                  time: {
                    parser: 'yyyy-MM-dd HH:mm',
                    tooltipFormat: 'dd.MM.yyyy HH:mm',
                    displayFormats: {
                      day: 'dd.MM.yyyy'
                    }
                  },
                  title: {
                    display: true,
                    text: 'Time'
                  }
                },
                y: {
                  min: 0,
                  max: 2,
                  ticks: {
                    stepSize: 1,
                    callback: (value) => {
                      const labels = ['Mild', 'Moderate', 'Severe'];
                      return labels[value] || value;
                    }
                  },
                  title: {
                    display: true,
                    text: 'Intensity'
                  }
                }
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const entry = context.raw.entry;
                      return [
                        `Date: ${entry.date}`,
                        `Time: ${entry.time}`,
                        `Duration: ${entry.duration || 'N/A'} minutes`,
                        `Intensity: ${entry.intensity || 'N/A'}`,
                        `Accompanying symptoms: ${entry.symptoms || 'N/A'}`,
                        `Stress situation: ${entry.stressSituation || 'N/A'}`,
                        `Interaction with family: ${entry.familyInteraction || 'N/A'}`,
                        `Stress signs: ${entry.stressSigns || 'N/A'}`,
                        `Sleep hours: ${entry.sleepHours || 'N/A'}`,
                        `Sleep quality: ${entry.sleepQuality || 'N/A'}`,
                        `Daily activity: ${entry.dailyActivity || 'N/A'}`,
                        `Chocolate amount: ${entry.chocolateAmount || 'N/A'}`,
                        `Cheese amount: ${entry.cheeseAmount || 'N/A'}`,
                        `Other foods: ${entry.otherFoods || 'N/A'}`,
                        `Water intake: ${entry.waterIntake || 'N/A'}`,
                        `Dehydration signs: ${entry.dehydrationSigns || 'N/A'}`,
                        `Snacks: ${entry.snacks || 'N/A'}`,
                        `Meal routine: ${entry.mealRoutine || 'N/A'}`,
                        `Screen time: ${entry.screenTime || 'N/A'}`,
                        `Allergies: ${entry.allergies || 'N/A'}`,
                        `Medical tests: ${entry.medicalTests || 'N/A'}`,
                        `Environmental changes: ${entry.environmentChanges || 'N/A'}`];
                    }
                  }
                }
              }
            }
          });
        }
        return () => {
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
          }
        };
      }, [entries]);

      const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
      };

      const handleApiKeyChange = (e) => {
        setApiKey(e.target.value);
        setAnalysisError('');
        setChatbotError('');
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        setEntries([...entries, formData]);
        setFormData({
          date: getCurrentDate(),
          time: getCurrentTime(),
          duration: '',
          intensity: '',
          symptoms: '',
          stressSituation: '',
          familyInteraction: '',
          stressSigns: '',
          sleepHours: '',
          sleepQuality: '',
          dailyActivity: '',
          chocolateAmount: '',
          cheeseAmount: '',
          otherFoods: '',
          waterIntake: '',
          dehydrationSigns: '',
          snacks: '',
          mealRoutine: '',
          screenTime: '',
          allergies: '',
          medicalTests: '',
          environmentChanges: ''
        });
      };

      const handleDelete = (index) => {
        const updatedEntries = entries.filter((_, i) => i !== index);
        setEntries(updatedEntries);
      };

      const handleShowDetails = (index) => {
        setSelectedEntry(entries[index]);
      };

      const handleAdoptEntry = (index) => {
        const entry = entries[index];
        setFormData({
          ...entry,
          date: getCurrentDate(),
          time: getCurrentTime()
        });
      };

      const handleCloseModal = () => {
        setSelectedEntry(null);
      };

      const downloadCSV = () => {
        const headers = [
          'Datum', 'Uhrzeit', 'Dauer', 'Intensit√§t', 'Begleitsymptome',
          'Stresssituation', 'Interaktion Familie', 'Stressanzeichen',
          'Schlafstunden', 'Schlafqualit√§t', 'T√§gliche Aktivit√§t',
          'Schokoladenmenge', 'K√§semenge', 'Andere Lebensmittel',
          'Wasseraufnahme', 'Dehydrationszeichen', 'Snacks',
          'Mahlzeitenroutine', 'Bildschirmzeit', 'Allergien',
          'Medizinische Tests', 'Umgebungsver√§nderungen'
        ];
        const rows = entries.map(entry => [
          entry.date, entry.time, entry.duration, entry.intensity, entry.symptoms,
          entry.stressSituation, entry.familyInteraction, entry.stressSigns,
          entry.sleepHours, entry.sleepQuality, entry.dailyActivity,
          entry.chocolateAmount, entry.cheeseAmount, entry.otherFoods,
          entry.waterIntake, entry.dehydrationSigns, entry.snacks,
          entry.mealRoutine, entry.screenTime, entry.allergies,
          entry.medicalTests, entry.environmentChanges
        ].map(field => `"${(field || '').toString().replace(/"/g, '""')}"`).join(','));

        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'headache-diary.csv';
        a.click();
        URL.revokeObjectURL(url);
      };

      const handleImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const text = event.target.result;
          const rows = text.split('\n').slice(1).filter(row => row.trim());
          const newEntries = rows.map(row => {
            const [
              date, time, duration, intensity, symptoms,
              stressSituation, familyInteraction, stressSigns,
              sleepHours, sleepQuality, dailyActivity,
              chocolateAmount, cheeseAmount, otherFoods,
              waterIntake, dehydrationSigns, snacks,
              mealRoutine, screenTime, allergies,
              medicalTests, environmentChanges
            ] = row.split(',').map(field => field.replace(/^"|"$/g, '').replace(/""/g, '"'));
            return {
              date, time, duration, intensity, symptoms,
              stressSituation, familyInteraction, stressSigns,
              sleepHours, sleepQuality, dailyActivity,
              chocolateAmount, cheeseAmount, otherFoods,
              waterIntake, dehydrationSigns, snacks,
              mealRoutine, screenTime, allergies,
              medicalTests, environmentChanges
            };
          });
          setEntries([...entries, ...newEntries.filter(entry => entry.date && entry.time)]);
          e.target.value = '';
        };
        reader.readAsText(file);
      };

      const analyzeWithOpenAI = async () => {
        if (!apiKey) {
          setAnalysisError('Please enter a valid OpenRouter API key.');
          return;
        }

        if (entries.length === 0) {
          setAnalysisError('No entries available for analysis.');
          return;
        }

        setAnalysisError('');
        setAnalysisResult('Analysis running...');

        try {
          const response = await fetch(AI_API_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
              'HTTP-Referer': window.location.origin,
              'X-Title': 'Headache Diary'
            },
            body: JSON.stringify({
              model: AI_CONFIG.model,
              messages: [
                {
                  role: 'user',
                  content: getHeadacheAnalysisPrompt(entries)
                }
              ],
              max_tokens: AI_CONFIG.maxTokens.headacheAnalysis,
              temperature: AI_CONFIG.temperature
            })
          });

          if (!response.ok) {
            throw new Error(`API-Fehler: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          const result = data.choices[0].message.content;
          setAnalysisResult(result);
        } catch (error) {
          setAnalysisError(`Error during analysis: ${error.message}`);
          setAnalysisResult('');
        }
      };

      const downloadAnalysis = () => {
        if (!analysisResult) {
          setAnalysisError('No analysis available for download.');
          return;
        }

        const blob = new Blob([analysisResult], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'headache-analysis.txt';
        a.click();
        URL.revokeObjectURL(url);
      };

      // Function to render Markdown safely in HTML
      const renderMarkdown = (markdownText) => {
        const html = marked.parse(markdownText);
        return DOMPurify.sanitize(html);
      };

      return (
        <div className="container mx-auto p-4">
          <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
            <p><strong>Disclaimer:</strong> This application is designed for personal use and educational purposes. For medical advice, please consult qualified healthcare professionals.</p>
          </div>
          <h1 className="text-2xl font-bold mb-4">üêªHeadache Diary</h1>

          {/* API Key Configuration */}
          <div className="mb-6 bg-blue-50 p-4 rounded border-l-4 border-blue-400">
            <h2 className="text-lg font-semibold mb-2">OpenRouter API Configuration</h2>
            <div className="flex items-center space-x-4">
              <div className="flex-1">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  API Key
                </label>
                <input
                  type="password"
                  value={apiKey}
                  onChange={handleApiKeyChange}
                  placeholder="Enter your OpenRouter API key"
                  className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div className="text-sm text-gray-600 max-w-md">
                <p>Required for chatbot and analysis functions.</p>
                <p>Get API key from <a href="https://openrouter.ai/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">openrouter.ai</a>.</p>
              </div>
            </div>
          </div>

          {/* Formular */}
          <form onSubmit={handleSubmit} className="space-y-4 bg-gray-100 p-4 rounded">
            <div className="flex justify-between items-center">
              <h2 className="text-xl font-semibold">New Entry</h2>
              <button
                type="button"
                onClick={() => setChatbotOpen(true)}
                className="bg-purple-500 text-white p-2 rounded hover:bg-purple-600"
              >
                {localStorage.getItem('chatbotState') ? 'Resume form assistant entry' : 'Create entry with form assistant'}
              </button>
            </div>
            {chatbotError && (
              <p className="text-red-500 mb-4">{chatbotError}</p>
            )}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block">Date</label>
                <input type="date" name="date" value={formData.date} onChange={handleChange} className="w-full p-2 border rounded" required />
              </div>
              <div>
                <label className="block">Time</label>
                <input type="time" name="time" value={formData.time} onChange={handleChange} className="w-full p-2 border rounded" required />
              </div>
              <div>
                <label className="block">Duration (in minutes)</label>
                <input type="number" name="duration" value={formData.duration} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Intensity</label>
                <select
                  name="intensity"
                  value={formData.intensity}
                  onChange={handleChange}
                  className="w-full p-2 border rounded"
                  required
                >
                  <option value="" disabled>Choose an intensity</option>
                  <option value="mild">Mild</option>
                  <option value="moderate">Moderate</option>
                  <option value="severe">Severe</option>
                </select>
              </div>
              <div>
                <label className="block">Accompanying symptoms (e.g. nausea, no glasses, light sensitivity)</label>
                <input type="text" name="symptoms" value={formData.symptoms} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Stress situation (e.g. argument with brother)</label>
                <input type="text" name="stressSituation" value={formData.stressSituation} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Interaction with family (e.g. reaction to family situation)</label>
                <input type="text" name="familyInteraction" value={formData.familyInteraction} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Stress signs (e.g. anxiety, overload)</label>
                <input type="text" name="stressSigns" value={formData.stressSigns} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Sleep hours per night</label>
                <input type="number" name="sleepHours" value={formData.sleepHours} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Sleep quality (e.g. restless, frequent waking)</label>
                <input type="text" name="sleepQuality" value={formData.sleepQuality} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Daily activity (e.g. outdoor exercise)</label>
                <input type="text" name="dailyActivity" value={formData.dailyActivity} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Chocolate amount (e.g. number of cookies)</label>
                <input type="text" name="chocolateAmount" value={formData.chocolateAmount} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Cheese amount</label>
                <input type="text" name="cheeseAmount" value={formData.cheeseAmount} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Other foods</label>
                <input type="text" name="otherFoods" value={formData.otherFoods} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Water intake (e.g. glasses per day)</label>
                <input type="text" name="waterIntake" value={formData.waterIntake} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Dehydration signs (e.g. dark urine)</label>
                <input type="text" name="dehydrationSigns" value={formData.dehydrationSigns} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Evening snacks</label>
                <input type="text" name="snacks" value={formData.snacks} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Meal routine (e.g. fixed or unstructured)</label>
                <input type="text" name="mealRoutine" value={formData.mealRoutine} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Screen time (hours per day)</label>
                <input type="text" name="screenTime" value={formData.screenTime} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Allergies/intolerances</label>
                <input type="text" name="allergies" value={formData.allergies} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Medical tests (e.g. blood tests)</label>
                <input type="text" name="medicalTests" value={formData.medicalTests} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block">Environmental changes (e.g. new kindergarten)</label>
                <input type="text" name="environmentChanges" value={formData.environmentChanges} onChange={handleChange} className="w-full p-2 border rounded" />
              </div>
            </div>
            <button type="submit" className="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Save entry</button>
          </form>

          {/* Chatbot Modal */}
          {chatbotOpen && (
            <Chatbot
              formData={formData}
              setFormData={setFormData}
              apiKey={apiKey}
              setChatbotOpen={setChatbotOpen}
              setChatbotError={setChatbotError}
            />
          )}

          {/* Recommendations */}
          <div className="mt-8 bg-gray-100 p-4 rounded">
            <h2 className="text-xl font-semibold">Recommendations</h2>
            <ul className="list-disc pl-5">
              <li>Maintain this headache diary regularly to identify patterns.</li>
              <li>Improve sleep hygiene: Set fixed bedtime and more outdoor activity (10-11 hours of sleep per night).</li>
              <li>Adjust diet: Temporarily reduce chocolate and cheese to test for potential triggers.</li>
              <li>Monitor fluid intake: Ensure the child drinks about 1-1.5 liters of water per day.</li>
              <li>Consult a pediatrician/neurologist to rule out other causes.</li>
            </ul>
          </div>

          {/* Show entries */}
          <div className="mt-8">
            <h2 className="text-xl font-semibold">Saved Entries</h2>
            <div className="flex space-x-4 mb-4">
              <button onClick={downloadCSV} className="bg-green-500 text-white p-2 rounded hover:bg-green-600">Download as CSV</button>
              <label className="bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600 cursor-pointer">
                Import CSV
                <input type="file" accept=".csv" onChange={handleImport} className="hidden" />
              </label>
            </div>
            {entries.length > 0 ? (
              <div>
                <div className="mb-8">
                  <h3 className="text-lg font-semibold mb-2">Intensity over Time</h3>
                  <canvas ref={chartRef} className="max-h-[400px]"></canvas>
                </div>
                <div className="mb-8">
                  <h3 className="text-lg font-semibold mb-2">AI Analysis via OpenRouter</h3>
                  <p className="text-sm text-gray-600 mb-4">This AI analysis is for informational purposes only and does not constitute medical advice. Please consult a healthcare professional for medical concerns.</p>
                  <div className="flex space-x-4 mb-4">
                    <button
                      onClick={analyzeWithOpenAI}
                      className="bg-indigo-500 text-white p-2 rounded hover:bg-indigo-600"
                    >
                      Analyze
                    </button>
                    {analysisResult && (
                      <button
                        onClick={downloadAnalysis}
                        className="bg-teal-500 text-white p-2 rounded hover:bg-teal-600"
                      >
                        Download analysis
                      </button>
                    )}
                  </div>
                  {analysisError && (
                    <p className="text-red-500 mb-4">{analysisError}</p>
                  )}
                  {analysisResult && (
                    <div className="bg-gray-100 p-4 rounded prose max-w-none">
                      <div dangerouslySetInnerHTML={{ __html: renderMarkdown(analysisResult) }} />
                    </div>
                  )}
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full border-collapse border">
                    <thead>
                      <tr className="bg-gray-200">
                        <th className="border p-2">Date</th>
                        <th className="border p-2">Time</th>
                        <th className="border p-2">Duration</th>
                        <th className="border p-2">Intensity</th>
                        <th className="border p-2">Symptoms</th>
                        <th className="border p-2">Stress Situation</th>
                        <th className="border p-2">Family Interaction</th>
                        <th className="border p-2">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {entries.map((entry, index) => (
                        <tr key={index}>
                          <td className="border p-2">{entry.date}</td>
                          <td className="border p-2">{entry.time}</td>
                          <td className="border p-2">{entry.duration}</td>
                          <td className="border p-2">{entry.intensity}</td>
                          <td className="border p-2">{entry.symptoms}</td>
                          <td className="border p-2">{entry.stressSituation}</td>
                          <td className="border p-2">{entry.familyInteraction}</td>
                          <td className="border p-2">
                            <div className="flex space-x-2">
                              <button
                                onClick={() => handleShowDetails(index)}
                                className="bg-blue-500 text-white p-1 rounded hover:bg-blue-600"
                              >
                                Details
                              </button>
                              <button
                                onClick={() => handleAdoptEntry(index)}
                                className="bg-purple-500 text-white p-1 rounded hover:bg-purple-600"
                              >
                                Adopt
                              </button>
                              <button
                                onClick={() => handleDelete(index)}
                                className="bg-red-500 text-white p-1 rounded hover:bg-red-600"
                              >
                                Delete
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            ) : (
              <p>No entries available.</p>
            )}
          </div>

          {/* Modal f√ºr vollst√§ndige Details */}
          {selectedEntry && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
              <div className="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                <h3 className="text-xl font-semibold mb-4">Entry Details</h3>
                <div className="grid grid-cols-1 gap-4">
                  <div><strong>Date:</strong> {selectedEntry.date}</div>
                  <div><strong>Time:</strong> {selectedEntry.time}</div>
                  <div><strong>Duration (minutes):</strong> {selectedEntry.duration}</div>
                  <div><strong>Intensity:</strong> {selectedEntry.intensity}</div>
                  <div><strong>Symptoms:</strong> {selectedEntry.symptoms}</div>
                  <div><strong>Stress Situation:</strong> {selectedEntry.stressSituation}</div>
                  <div><strong>Family Interaction:</strong> {selectedEntry.familyInteraction}</div>
                  <div><strong>Stress Signs:</strong> {selectedEntry.stressSigns}</div>
                  <div><strong>Sleep Hours per Night:</strong> {selectedEntry.sleepHours}</div>
                  <div><strong>Sleep Quality:</strong> {selectedEntry.sleepQuality}</div>
                  <div><strong>Daily Activity:</strong> {selectedEntry.dailyActivity}</div>
                  <div><strong>Chocolate Amount:</strong> {selectedEntry.chocolateAmount}</div>
                  <div><strong>Cheese Amount:</strong> {selectedEntry.cheeseAmount}</div>
                  <div><strong>Other Foods:</strong> {selectedEntry.otherFoods}</div>
                  <div><strong>Water Intake:</strong> {selectedEntry.waterIntake}</div>
                  <div><strong>Dehydration Signs:</strong> {selectedEntry.dehydrationSigns}</div>
                  <div><strong>Evening Snacks:</strong> {selectedEntry.snacks}</div>
                  <div><strong>Meal Routine:</strong> {selectedEntry.mealRoutine}</div>
                  <div><strong>Screen Time:</strong> {selectedEntry.screenTime}</div>
                  <div><strong>Allergies/Intolerances:</strong> {selectedEntry.allergies}</div>
                  <div><strong>Medical Tests:</strong> {selectedEntry.medicalTests}</div>
                  <div><strong>Environmental Changes:</strong> {selectedEntry.environmentChanges}</div>
                </div>
                <button
                  onClick={handleCloseModal}
                  className="mt-4 bg-gray-500 text-white p-2 rounded hover:bg-gray-600"
                >
                  Close
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<HeadacheDiary />, document.getElementById('root'));
  </script>
</body>
</html>
