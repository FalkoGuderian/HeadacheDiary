<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Headache Diary</title>
  <link href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iOCIgY3k9IjgiIHI9IjYiIGZpbGw9IiM4QjQ1MTMiLz48Y2lyY2xlIGN4PSI1LjUiIGN5PSI1LjUiIHI9IjEuNSIgZmlsbD0iI0ZGRTNCRjUiLz48Y2lyY2xlIGN4PSIxMC41IiBjeT0iNS41IiByPSIxLjUiIGZpbGw9IiNGRkU0QjUiLz48Y2lyY2xlIGN4PSI1LjUiIGN5PSI1LjUiIHI9IjAuNSIgZmlsbD0iIzAwMCIvPjxjaXJjbGUgY3g9IjEwLjUiIGN5PSI1LjUiIHI9IjAuNSIgZmlsbD0iIzAwMCIvPjxjaXJjbGUgY3g9IjYiIGN5PSIxMCIgcj0iMSIgZmlsbD0iI0ZGRTNCRjUiLz48Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIxIiBmaWxsPSIjRkZFNEI1Ii8+PGVsbGlwc2UgY3g9IjQuNSIgY3k9IjciIHJ4PSIxIiByeT0iMiIgZmlsbD0iIzhCNDUxMyIvPjxlbGxpcHNlIGN4PSIxMS41IiBjeT0iNyIgcng9IjEiIHJ5PSIyIiBmaWxsPSIjOEI0NTEzIi8+</svg>" rel="icon">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script src="js/utils.js"></script>
  <script type="text/babel">
    // AI Prompts Configuration
    const AI_CONFIG = {
      model: 'x-ai/grok-4-fast',
      temperature: 0.7,
      maxTokens: {
        chatbotParsing: 500,
        headacheAnalysis: 2000
      }
    };

    const AI_API_ENDPOINT = 'https://openrouter.ai/api/v1/chat/completions';

    function getChatbotParsingPrompt(userInput, questions, currentStep) {
      const currentQuestion = questions[currentStep];
      const today = new Date().toISOString().split('T')[0];
      return `You are an assistant that analyzes user inputs and converts them into structured data for a headache diary. Break down the input into the following fields: ${currentQuestion.fields.join(', ')}. Return the answer in JSON format, e.g. { "field1": "value1", "field2": "value2" }. If a field cannot be clearly filled, leave it empty ("").

IMPORTANT INSTRUCTIONS:
- For date fields: Convert relative dates like "today", "yesterday", "tomorrow" to YYYY-MM-DD format. Also handle European date formats like "12.11.2025" â†’ "2025-11-12". Today's date is ${today}.
- For time fields: Convert times like "2pm", "2:00 PM", "14:00" to 24-hour format (HH:MM). For example: "2pm" becomes "14:00", "9am" becomes "09:00".
- For duration fields: Extract only the numeric value in minutes. For example: "10 minutes" or "10min" becomes 10, "2 hours" becomes 120.
- Handle both natural language and structured input (e.g., "Date 12.11.2025 Time 14:00 Duration 10 Intensity Mild").
- Only extract information that is clearly mentioned in the user input.

User input: "${userInput}"

Fields: ${currentQuestion.fields.join(', ')}

Respond only with the JSON object, without additional text.`;
    }

    function getHeadacheAnalysisPrompt(entries) {
      const historyText = entries.map((entry, index) => {
        return `Entry ${index + 1}:
- Date: ${entry.date}
- Time: ${entry.time}
- Duration: ${entry.duration || 'N/A'} minutes
- Intensity: ${entry.intensity || 'N/A'}
- Accompanying symptoms: ${entry.symptoms || 'N/A'}
- Stress situation: ${entry.stressSituation || 'N/A'}
- Interaction with family: ${entry.familyInteraction || 'N/A'}
- Stress signs: ${entry.stressSigns || 'N/A'}
- Sleep hours: ${entry.sleepHours || 'N/A'}
- Sleep quality: ${entry.sleepQuality || 'N/A'}
- Daily activity: ${entry.dailyActivity || 'N/A'}
- Chocolate amount: ${entry.chocolateAmount || 'N/A'}
- Cheese amount: ${entry.cheeseAmount || 'N/A'}
- Other foods: ${entry.otherFoods || 'N/A'}
- Water intake: ${entry.waterIntake || 'N/A'}
- Dehydration signs: ${entry.dehydrationSigns || 'N/A'}
- Snacks: ${entry.snacks || 'N/A'}
- Meal routine: ${entry.mealRoutine || 'N/A'}
- Screen time: ${entry.screenTime || 'N/A'}
- Allergies: ${entry.allergies || 'N/A'}
- Medical tests: ${entry.medicalTests || 'N/A'}
- Environmental changes: ${entry.environmentChanges || 'N/A'}\n`;
      }).join('\n');

      return `You are a medical expert for headaches. Analyze the following history of headache entries from a patient. Identify the most likely cause(s) for the headaches based on the data (e.g. stress, diet, sleep, dehydration, environmental changes). Provide concrete measures to prevent the headaches based on the identified causes. The answer should be clear, concise, and formulated in English. Return the answer in the following format:

**Most Likely Cause(s):**
- [Cause 1]
- [Cause 2, if applicable]

**Recommended Measures:**
- [Measure 1]
- [Measure 2]
- ...

**Note:** If the data is insufficient to identify a specific cause, provide the most likely possibilities and recommend general measures as well as further investigations.

**History:**
${historyText}`;
    }

    const { useState, useEffect, useRef } = React;

    // Chatbot Component
    const Chatbot = ({ formData, setFormData, apiKey, setChatbotOpen, setChatbotError }) => {
      // Load saved chatbot state from localStorage
      const loadSavedState = () => {
        try {
          const saved = localStorage.getItem('chatbotState');
          return saved ? JSON.parse(saved) : null;
        } catch (e) {
          return null;
        }
      };

      const savedState = loadSavedState();
      const [messages, setMessages] = useState(savedState?.messages || []);
      const [userInput, setUserInput] = useState('');
      const [currentStep, setCurrentStep] = useState(savedState?.currentStep || 0);
      const [collectedData, setCollectedData] = useState(savedState?.collectedData || {});

      // Question structure in groups
      const questions = [
        {
          prompt: "When did you have the headache? Please provide date (e.g. 2025-05-18), time (e.g. 14:30), duration in minutes, and intensity (mild, moderate, or severe).",
          fields: ['date', 'time', 'duration', 'intensity']
        },
        {
          prompt: "What accompanying symptoms did you have (e.g. nausea, light sensitivity)? Was there a stress situation (e.g. argument with brother)? How was the interaction with the family (e.g. reaction to family situation)? Were there stress signs (e.g. anxiety, overload)?",
          fields: ['symptoms', 'stressSituation', 'familyInteraction', 'stressSigns']
        },
        {
          prompt: "How many hours did you sleep? How was the sleep quality (e.g. restless, frequent waking)? What daily activity did you perform (e.g. outdoor exercise)?",
          fields: ['sleepHours', 'sleepQuality', 'dailyActivity']
        },
        {
          prompt: "How much chocolate (e.g. number of cookies) and cheese did you eat? What other foods did you consume? How much water did you drink (e.g. glasses per day)? Were there dehydration signs (e.g. dark urine)? What snacks did you eat in the evening? How was your meal routine (e.g. fixed or unstructured)?",
          fields: ['chocolateAmount', 'cheeseAmount', 'otherFoods', 'waterIntake', 'dehydrationSigns', 'snacks', 'mealRoutine']
        },
        {
          prompt: "How much screen time did you have (hours per day)? Do you have allergies or intolerances? Were there medical tests (e.g. blood tests)? Were there environmental changes (e.g. new kindergarten)?",
          fields: ['screenTime', 'allergies', 'medicalTests', 'environmentChanges']
        }
      ];

      // Startnachricht
      useEffect(() => {
        if (currentStep === 0) {
          setMessages([{ text: questions[0].prompt, isBot: true }]);
        }
      }, []);

      const handleUserInput = async (e) => {
        e.preventDefault();
        if (!userInput.trim()) return;

        // FÃ¼ge Benutzernachricht hinzu
        setMessages([...messages, { text: userInput, isBot: false }]);
        const currentQuestion = questions[currentStep];

        // Sende Eingabe an OpenRouter, um Antworten in Felder aufzuteilen
        try {
          const response = await fetch(window.AI_API_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
              'HTTP-Referer': window.location.origin,
              'X-Title': 'Headache Diary'
            },
            body: JSON.stringify({
              model: AI_CONFIG.model,
              messages: [
                {
                  role: 'user',
                  content: getChatbotParsingPrompt(userInput, questions, currentStep)
                }
              ],
              max_tokens: AI_CONFIG.maxTokens.chatbotParsing,
              temperature: AI_CONFIG.temperature
            })
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          const parsedData = JSON.parse(data.choices[0].message.content);

          // Aktualisiere gesammelte Daten
          const newCollectedData = { ...collectedData, ...parsedData };
          setCollectedData(newCollectedData);

          // PrÃ¼fe, ob alle Felder der aktuellen Frage ausgefÃ¼llt wurden
          const currentQuestionFields = questions[currentStep].fields;
          const allFieldsFilled = currentQuestionFields.every(field => parsedData[field] && parsedData[field] !== "");

          if (allFieldsFilled && currentStep < questions.length - 1) {
            // Alle Felder ausgefÃ¼llt, automatisch zur nÃ¤chsten Frage
            setCurrentStep(currentStep + 1);
            setMessages([...messages, { text: userInput, isBot: false }, { text: questions[currentStep + 1].prompt, isBot: true }]);
          } else {
            // Nicht alle Felder ausgefÃ¼llt oder letzte Frage, Optionen anzeigen
            setMessages([...messages, { text: userInput, isBot: false }, {
              text: `Data collected so far: ${Object.keys(newCollectedData).length > 0 ? Object.keys(newCollectedData).join(', ') : 'none'}. What would you like to do?`,
              isBot: true,
              isOptions: true
            }]);
          }
        } catch (error) {
          if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            setChatbotError('Please enter your OpenRouter API key in the "Config & Data" tab to use AI assistance.');
          } else {
            setChatbotError(`Error during processing: ${error.message}`);
          }
        }

        setUserInput('');
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
          <div className="bg-white p-6 rounded-lg max-w-lg w-full max-h-[80vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-semibold">AI Quick Fill Assistant</h3>
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    // Save current data to form and chatbot state to localStorage
                    setFormData({ ...formData, ...collectedData });
                    const chatbotState = {
                      messages,
                      currentStep,
                      collectedData
                    };
                    localStorage.setItem('chatbotState', JSON.stringify(chatbotState));
                  }}
                  className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium text-sm"
                  title="Save progress to continue later"
                >
                  ðŸ’¾ Save
                </button>
                <button
                  onClick={() => {
                    // Restart chatbot conversation
                    setMessages([{ text: questions[0].prompt, isBot: true }]);
                    setCurrentStep(0);
                    setCollectedData({});
                    localStorage.removeItem('chatbotState');
                  }}
                  className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium text-sm"
                  title="Restart conversation from beginning"
                >
                  ðŸ”„ Restart
                </button>
              </div>
            </div>
            <div className="space-y-4">
              {messages.map((msg, index) => (
                <div key={index}>
                  <div className={`p-2 rounded ${msg.isBot ? 'bg-blue-100' : 'bg-gray-100 text-right'}`}>
                    {msg.text}
                  </div>
                  {msg.isOptions && (
                    <div className="flex flex-wrap gap-2 mt-2 ml-2">
                      {currentStep < questions.length - 1 && (
                        <button
                          onClick={() => {
                            setCurrentStep(prev => {
                              const nextStep = prev + 1;
                              setMessages(prevMsgs => [...prevMsgs, { text: questions[nextStep].prompt, isBot: true }]);
                              return nextStep;
                            });
                          }}
                          className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium text-sm"
                        >
                          Continue to next question
                        </button>
                      )}
                      <button
                        onClick={() => {
                          setFormData({ ...formData, ...collectedData });
                          setChatbotOpen(false);
                          setMessages([]);
                          setCurrentStep(0);
                          setCollectedData({});
                          localStorage.removeItem('chatbotState'); // Clear saved state
                        }}
                        className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium text-sm"
                      >
                        Save and finish
                      </button>
                      <button
                        onClick={() => {
                          // Save chatbot state to localStorage
                          const chatbotState = {
                            messages,
                            currentStep,
                            collectedData
                          };
                          localStorage.setItem('chatbotState', JSON.stringify(chatbotState));

                          setFormData({ ...formData, ...collectedData });
                          setChatbotOpen(false);
                        }}
                        className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium text-sm"
                      >
                        Save and continue later
                      </button>
                    </div>
                  )}
                </div>
              ))}
            </div>
            <form onSubmit={handleUserInput} className="mt-4">
              <input
                type="text"
                value={userInput}
                onChange={(e) => setUserInput(e.target.value)}
                className="w-full p-2 border rounded"
                placeholder="Your answer..."
              />
              <div className="flex space-x-2 mt-2">
                <button
                  type="submit"
                  className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium"
                >
                  Send answer
                </button>
                <button
                  type="button"
                  onClick={() => setChatbotOpen(false)}
                  className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Main HeadacheDiary Component
    const HeadacheDiary = () => {
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);
      const [chatbotOpen, setChatbotOpen] = useState(false);
      const [chatbotError, setChatbotError] = useState('');

      const getCurrentDate = () => {
        const now = new Date();
        return now.toISOString().split('T')[0];
      };

      const getCurrentTime = () => {
        const now = new Date();
        return now.toTimeString().slice(0, 5);
      };

      const [entries, setEntries] = useState([]);
      const [formData, setFormData] = useState({
        date: getCurrentDate(),
        time: getCurrentTime(),
        duration: '',
        intensity: '',
        symptoms: '',
        stressSituation: '',
        familyInteraction: '',
        stressSigns: '',
        sleepHours: '',
        sleepQuality: '',
        dailyActivity: '',
        chocolateAmount: '',
        cheeseAmount: '',
        otherFoods: '',
        waterIntake: '',
        dehydrationSigns: '',
        snacks: '',
        mealRoutine: '',
        screenTime: '',
        allergies: '',
        medicalTests: '',
        environmentChanges: ''
      });
      const [selectedEntry, setSelectedEntry] = useState(null);
      const [editingEntry, setEditingEntry] = useState(null);
      const [apiKey, setApiKey] = useState('');
      const [analysisResult, setAnalysisResult] = useState('');
      const [analysisError, setAnalysisError] = useState('');

      useEffect(() => {
        const savedEntries = JSON.parse(localStorage.getItem('headacheEntries') || '[]');
        setEntries(savedEntries);
      }, []);

      useEffect(() => {
        localStorage.setItem('headacheEntries', JSON.stringify(entries));
      }, [entries]);

      // Initialize tabs when component mounts
      useEffect(() => {
        // Small delay to ensure DOM is ready
        setTimeout(() => {
          if (window.initializeTabs) {
            window.initializeTabs();
          }
        }, 100);
      }, []);

      useEffect(() => {
        if (chartRef.current) {
          const ctx = chartRef.current.getContext('2d');
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
          }
          const intensityMap = {
            'mild': 0,
            'moderate': 1,
            'severe': 2
          };
          const data = entries.map(entry => ({
            x: `${entry.date} ${entry.time}`,
            y: intensityMap[entry.intensity?.toLowerCase()] || 0,
            entry: entry
          }));
          chartInstanceRef.current = new Chart(ctx, {
            type: 'line',
            data: {
              datasets: [{
                label: 'Headache Intensity',
                data: data,
                borderColor: '#3b82f6',
                backgroundColor: '#3b82f6',
                tension: 0.1,
                pointRadius: 5,
                pointHoverRadius: 8
              }]
            },
            options: {
              layout: {
                padding: {
                  top: 15,
                  bottom: 15
                }
              },
              scales: {
                x: {
                  type: 'time',
                  time: {
                    parser: 'yyyy-MM-dd HH:mm',
                    tooltipFormat: 'dd.MM.yyyy HH:mm',
                    displayFormats: {
                      day: 'dd.MM.yyyy'
                    }
                  },
                  title: {
                    display: true,
                    text: 'Time'
                  }
                },
                y: {
                  ticks: {
                    stepSize: 1,
                    callback: (value) => {
                      const labels = ['Mild', 'Moderate', 'Severe'];
                      return labels[Math.round(value)] || '';
                    }
                  },
                  title: {
                    display: true,
                    text: 'Intensity'
                  }
                }
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const entry = context.raw.entry;
                      return [
                        `Date: ${entry.date}`,
                        `Time: ${entry.time}`,
                        `Duration: ${entry.duration || 'N/A'} minutes`,
                        `Intensity: ${entry.intensity || 'N/A'}`,
                        `Accompanying symptoms: ${entry.symptoms || 'N/A'}`,
                        `Stress situation: ${entry.stressSituation || 'N/A'}`,
                        `Interaction with family: ${entry.familyInteraction || 'N/A'}`,
                        `Stress signs: ${entry.stressSigns || 'N/A'}`,
                        `Sleep hours: ${entry.sleepHours || 'N/A'}`,
                        `Sleep quality: ${entry.sleepQuality || 'N/A'}`,
                        `Daily activity: ${entry.dailyActivity || 'N/A'}`,
                        `Chocolate amount: ${entry.chocolateAmount || 'N/A'}`,
                        `Cheese amount: ${entry.cheeseAmount || 'N/A'}`,
                        `Other foods: ${entry.otherFoods || 'N/A'}`,
                        `Water intake: ${entry.waterIntake || 'N/A'}`,
                        `Dehydration signs: ${entry.dehydrationSigns || 'N/A'}`,
                        `Snacks: ${entry.snacks || 'N/A'}`,
                        `Meal routine: ${entry.mealRoutine || 'N/A'}`,
                        `Screen time: ${entry.screenTime || 'N/A'}`,
                        `Allergies: ${entry.allergies || 'N/A'}`,
                        `Medical tests: ${entry.medicalTests || 'N/A'}`,
                        `Environmental changes: ${entry.environmentChanges || 'N/A'}`];
                    }
                  }
                }
              }
            }
          });
        }
        return () => {
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
          }
        };
      }, [entries]);

      const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
      };

      const handleApiKeyChange = (e) => {
        setApiKey(e.target.value);
        setAnalysisError('');
        setChatbotError('');
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (editingEntry !== null) {
          // Update existing entry
          const updatedEntries = [...entries];
          updatedEntries[editingEntry] = formData;
          setEntries(updatedEntries);
          setEditingEntry(null);
        } else {
          // Create new entry
          setEntries([...entries, formData]);
        }

        setFormData({
          date: getCurrentDate(),
          time: getCurrentTime(),
          duration: '',
          intensity: '',
          symptoms: '',
          stressSituation: '',
          familyInteraction: '',
          stressSigns: '',
          sleepHours: '',
          sleepQuality: '',
          dailyActivity: '',
          chocolateAmount: '',
          cheeseAmount: '',
          otherFoods: '',
          waterIntake: '',
          dehydrationSigns: '',
          snacks: '',
          mealRoutine: '',
          screenTime: '',
          allergies: '',
          medicalTests: '',
          environmentChanges: ''
        });
      };

      const handleDelete = (index) => {
        const updatedEntries = entries.filter((_, i) => i !== index);
        setEntries(updatedEntries);
      };

      const handleShowDetails = (index) => {
        setSelectedEntry(entries[index]);
      };

      const handleAdoptEntry = (index) => {
        const entry = entries[index];
        setFormData({
          ...entry,
          date: getCurrentDate(),
          time: getCurrentTime()
        });
        switchTab('entry'); // Switch to New Entry tab
      };

      const handleEditEntry = (index) => {
        const entry = entries[index];
        setEditingEntry(index);
        setFormData({ ...entry });
        switchTab('entry'); // Switch to New Entry tab
      };

      const handleCancelEdit = () => {
        setEditingEntry(null);
        setFormData({
          date: getCurrentDate(),
          time: getCurrentTime(),
          duration: '',
          intensity: '',
          symptoms: '',
          stressSituation: '',
          familyInteraction: '',
          stressSigns: '',
          sleepHours: '',
          sleepQuality: '',
          dailyActivity: '',
          chocolateAmount: '',
          cheeseAmount: '',
          otherFoods: '',
          waterIntake: '',
          dehydrationSigns: '',
          snacks: '',
          mealRoutine: '',
          screenTime: '',
          allergies: '',
          medicalTests: '',
          environmentChanges: ''
        });
      };

      const handleCloseModal = () => {
        setSelectedEntry(null);
      };

      const downloadCSV = () => {
        const headers = [
          'Datum', 'Uhrzeit', 'Dauer', 'IntensitÃ¤t', 'Begleitsymptome',
          'Stresssituation', 'Interaktion Familie', 'Stressanzeichen',
          'Schlafstunden', 'SchlafqualitÃ¤t', 'TÃ¤gliche AktivitÃ¤t',
          'Schokoladenmenge', 'KÃ¤semenge', 'Andere Lebensmittel',
          'Wasseraufnahme', 'Dehydrationszeichen', 'Snacks',
          'Mahlzeitenroutine', 'Bildschirmzeit', 'Allergien',
          'Medizinische Tests', 'UmgebungsverÃ¤nderungen'
        ];
        const rows = entries.map(entry => [
          entry.date, entry.time, entry.duration, entry.intensity, entry.symptoms,
          entry.stressSituation, entry.familyInteraction, entry.stressSigns,
          entry.sleepHours, entry.sleepQuality, entry.dailyActivity,
          entry.chocolateAmount, entry.cheeseAmount, entry.otherFoods,
          entry.waterIntake, entry.dehydrationSigns, entry.snacks,
          entry.mealRoutine, entry.screenTime, entry.allergies,
          entry.medicalTests, entry.environmentChanges
        ].map(field => `"${(field || '').toString().replace(/"/g, '""')}"`).join(','));

        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'headache-diary.csv';
        a.click();
        URL.revokeObjectURL(url);
      };

      const handleImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const text = event.target.result;
          const rows = text.split('\n').slice(1).filter(row => row.trim());
          const newEntries = rows.map(row => {
            const [
              date, time, duration, intensity, symptoms,
              stressSituation, familyInteraction, stressSigns,
              sleepHours, sleepQuality, dailyActivity,
              chocolateAmount, cheeseAmount, otherFoods,
              waterIntake, dehydrationSigns, snacks,
              mealRoutine, screenTime, allergies,
              medicalTests, environmentChanges
            ] = row.split(',').map(field => field.replace(/^"|"$/g, '').replace(/""/g, '"'));
            return {
              date, time, duration, intensity, symptoms,
              stressSituation, familyInteraction, stressSigns,
              sleepHours, sleepQuality, dailyActivity,
              chocolateAmount, cheeseAmount, otherFoods,
              waterIntake, dehydrationSigns, snacks,
              mealRoutine, screenTime, allergies,
              medicalTests, environmentChanges
            };
          });
          setEntries([...entries, ...newEntries.filter(entry => entry.date && entry.time)]);
          e.target.value = '';
        };
        reader.readAsText(file);
      };

      const analyzeWithOpenAI = async () => {
        if (!apiKey) {
          setAnalysisError('Please enter a valid OpenRouter API key.');
          return;
        }

        if (entries.length === 0) {
          setAnalysisError('No entries available for analysis.');
          return;
        }

        setAnalysisError('');
        setAnalysisResult('Analysis running...');

        try {
          const response = await fetch(AI_API_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
              'HTTP-Referer': window.location.origin,
              'X-Title': 'Headache Diary'
            },
            body: JSON.stringify({
              model: AI_CONFIG.model,
              messages: [
                {
                  role: 'user',
                  content: getHeadacheAnalysisPrompt(entries)
                }
              ],
              max_tokens: AI_CONFIG.maxTokens.headacheAnalysis,
              temperature: AI_CONFIG.temperature
            })
          });

          if (!response.ok) {
            throw new Error(`API-Fehler: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          const result = data.choices[0].message.content;
          setAnalysisResult(result);
        } catch (error) {
          setAnalysisError(`Error during analysis: ${error.message}`);
          setAnalysisResult('');
        }
      };

      const downloadAnalysis = () => {
        if (!analysisResult) {
          setAnalysisError('No analysis available for download.');
          return;
        }

        const blob = new Blob([analysisResult], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'headache-analysis.txt';
        a.click();
        URL.revokeObjectURL(url);
      };

      // Function to render Markdown safely in HTML
      const renderMarkdown = (markdownText) => {
        const html = marked.parse(markdownText);
        return DOMPurify.sanitize(html);
      };

      // Tab switching function
      const switchTab = (tabId) => {
        console.log('Switching to tab:', tabId);
        const tabs = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-content');

        console.log('Found tabs:', tabs.length, 'contents:', contents.length);

        // Remove active class from all tabs and hide all content
        tabs.forEach(tab => {
          tab.classList.remove('active');
          tab.classList.remove('bg-indigo-50');
          tab.classList.remove('border-indigo-500');
          tab.classList.remove('text-indigo-600');
          tab.classList.add('text-gray-500');
          tab.classList.add('border-transparent');
        });

        contents.forEach(content => {
          content.classList.remove('active');
          content.style.display = 'none';
        });

        const targetTab = document.getElementById(`tab-${tabId}`);
        const targetContent = document.getElementById(`content-${tabId}`);

        console.log('Target tab:', targetTab, 'target content:', targetContent);

        // Add active class to target tab and show target content
        if (targetTab) {
          targetTab.classList.add('active');
          targetTab.classList.add('bg-indigo-50');
          targetTab.classList.add('border-indigo-500');
          targetTab.classList.add('text-indigo-600');
          targetTab.classList.remove('text-gray-500');
          targetTab.classList.remove('border-transparent');
          targetTab.classList.remove('hover:text-gray-700');
          targetTab.classList.remove('hover:border-gray-300');
        }
        if (targetContent) {
          targetContent.classList.add('active');
          targetContent.style.display = 'block';
        }
      };

      // Initialize tabs on page load
      const initializeTabs = () => {
        console.log('Initializing tabs on page load');
        switchTab('entry'); // Start with entry tab active
      };

      window.switchTab = switchTab;
      window.initializeTabs = initializeTabs;

      return (
        <div className="container mx-auto p-4 md:p-8">
          <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
            <div className="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
              <div className="flex-1">
                <h1 className="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Headache Diary</h1>
                {entries.length > 0 && (
                  <div className="space-y-2">
                    <div className="flex gap-6">
                      <div className="flex items-center gap-2">
                        <div className="text-lg font-bold text-blue-600">{entries.length}</div>
                        <div className="text-sm text-gray-600">Total Entries</div>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="text-lg font-bold text-red-600">
                          {entries.filter(e => e.intensity?.toLowerCase() === 'severe').length}
                        </div>
                        <div className="text-sm text-gray-600">Severe Headaches</div>
                      </div>
                    </div>
                    <div className="text-sm text-gray-500">
                      Last entry: {entries[entries.length - 1]?.date} at {entries[entries.length - 1]?.time}
                    </div>
                  </div>
                )}
              </div>
              <div className="bg-gray-50 border-l-4 border-gray-300 text-gray-700 p-4 flex-shrink-0" role="alert">
                <p><strong className="text-red-600">Disclaimer:</strong> This application is designed for personal use and educational purposes. For medical advice, please consult qualified healthcare professionals.</p>
              </div>
            </div>
          </div>



          <div className="grid grid-cols-1 lg:grid-cols-5 gap-8">

            <div className="lg:col-span-5 bg-white rounded-xl shadow-lg overflow-hidden">

              <div className="border-b border-gray-200">
                <nav className="flex space-x-0" aria-label="Tabs">
                  <button id="tab-entry" className="tab-button flex-1 py-4 px-4 text-center border-b-2 font-medium text-sm focus:outline-none transition-colors bg-indigo-50 border-indigo-500 text-indigo-600 active" onClick={() => switchTab('entry')}>
                    <div className="flex items-center justify-center">
                      <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                      </svg>
                      <span className="hidden sm:inline">Record</span>
                    </div>
                  </button>
                  <button id="tab-analysis" className="tab-button flex-1 py-4 px-4 text-center border-b-2 font-medium text-sm focus:outline-none transition-colors text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" onClick={() => switchTab('analysis')}>
                    <div className="flex items-center justify-center">
                      <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                      </svg>
                      <span className="hidden sm:inline">Analysis</span>
                    </div>
                  </button>
                  <button id="tab-management" className="tab-button flex-1 py-4 px-4 text-center border-b-2 font-medium text-sm focus:outline-none transition-colors text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" onClick={() => switchTab('management')}>
                    <div className="flex items-center justify-center">
                      <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 3.108-1.756 3.534 0l.717 2.95a1.5 1.5 0 001.289 1.102l3.355.493c1.814.267 2.55 2.491 1.227 3.663l-2.605 2.54a1.5 1.5 0 00-.433 1.326l.616 3.068c.31 1.548-1.368 2.763-2.752 2.041L14.007 18a1.5 1.5 0 00-1.354 0l-3.205 1.691c-1.384.722-3.062-.493-2.752-2.041l.616-3.068a1.5 1.5 0 00-.433-1.326L4.48 12.564c-1.323-1.172-.587-3.397 1.227-3.663l3.355-.493a1.5 1.5 0 001.289-1.102l.717-2.95z"></path>
                      </svg>
                      <span className="hidden sm:inline">Config & Data</span>
                    </div>
                  </button>
                </nav>
              </div>

              <div className="p-6">
                <div id="content-entry" className="tab-content active">
                  <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="flex items-center gap-4">
                      <button
                        type="button"
                        onClick={() => setChatbotOpen(true)}
                        className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span>{localStorage.getItem('chatbotState') ? 'Resume Quick Fill' : 'Quick Fill'}</span>
                      </button>
                      <h2 className="text-xl font-semibold">{editingEntry !== null ? 'Edit Entry' : 'New Entry'}</h2>
                    </div>
                    {chatbotError && (
                      <p className="text-red-500 mb-4">{chatbotError}</p>
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block">Date</label>
                        <input type="date" name="date" value={formData.date} onChange={handleChange} className="w-full p-2 border rounded" required />
                      </div>
                      <div>
                        <label className="block">Time</label>
                        <input type="time" name="time" value={formData.time} onChange={handleChange} className="w-full p-2 border rounded" required />
                      </div>
                      <div>
                        <label className="block">Duration (in minutes)</label>
                        <input type="number" name="duration" value={formData.duration} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Intensity</label>
                        <select
                          name="intensity"
                          value={formData.intensity}
                          onChange={handleChange}
                          className="w-full p-2 border rounded"
                          required
                        >
                          <option value="" disabled>Choose an intensity</option>
                          <option value="mild">Mild</option>
                          <option value="moderate">Moderate</option>
                          <option value="severe">Severe</option>
                        </select>
                      </div>
                      <div>
                        <label className="block">Accompanying symptoms (e.g. nausea, no glasses, light sensitivity)</label>
                        <input type="text" name="symptoms" value={formData.symptoms} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Stress situation (e.g. argument with brother)</label>
                        <input type="text" name="stressSituation" value={formData.stressSituation} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Interaction with family (e.g. reaction to family situation)</label>
                        <input type="text" name="familyInteraction" value={formData.familyInteraction} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Stress signs (e.g. anxiety, overload)</label>
                        <input type="text" name="stressSigns" value={formData.stressSigns} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Sleep hours per night</label>
                        <input type="number" name="sleepHours" value={formData.sleepHours} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Sleep quality (e.g. restless, frequent waking)</label>
                        <input type="text" name="sleepQuality" value={formData.sleepQuality} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Daily activity (e.g. outdoor exercise)</label>
                        <input type="text" name="dailyActivity" value={formData.dailyActivity} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Chocolate amount (e.g. number of cookies)</label>
                        <input type="text" name="chocolateAmount" value={formData.chocolateAmount} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Cheese amount</label>
                        <input type="text" name="cheeseAmount" value={formData.cheeseAmount} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Other foods</label>
                        <input type="text" name="otherFoods" value={formData.otherFoods} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Water intake (e.g. glasses per day)</label>
                        <input type="text" name="waterIntake" value={formData.waterIntake} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Dehydration signs (e.g. dark urine)</label>
                        <input type="text" name="dehydrationSigns" value={formData.dehydrationSigns} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Evening snacks</label>
                        <input type="text" name="snacks" value={formData.snacks} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Meal routine (e.g. fixed or unstructured)</label>
                        <input type="text" name="mealRoutine" value={formData.mealRoutine} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Screen time (hours per day)</label>
                        <input type="text" name="screenTime" value={formData.screenTime} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Allergies/intolerances</label>
                        <input type="text" name="allergies" value={formData.allergies} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Medical tests (e.g. blood tests)</label>
                        <input type="text" name="medicalTests" value={formData.medicalTests} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                      <div>
                        <label className="block">Environmental changes (e.g. new kindergarten)</label>
                        <input type="text" name="environmentChanges" value={formData.environmentChanges} onChange={handleChange} className="w-full p-2 border rounded" />
                      </div>
                    </div>
                    <div className="flex gap-3">
                      <button type="submit" className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium">{editingEntry !== null ? 'Update Entry' : 'Save Entry'}</button>
                      {editingEntry !== null && (
                        <button
                          type="button"
                          onClick={handleCancelEdit}
                          className="bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-3 rounded-lg hover:from-red-600 hover:to-red-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium"
                        >
                          Cancel Edit
                        </button>
                      )}
                    </div>
                  </form>
                </div>

                <div id="content-analysis" className="tab-content">
                  <div className="space-y-6">
                    {entries.length > 0 ? (
                      <div>
                        <div className="mb-8">
                          <h3 className="text-lg font-semibold mb-2">Intensity over Time</h3>
                          <canvas ref={chartRef} className="max-h-[400px]"></canvas>
                        </div>
                        <div className="mb-8">
                          <h3 className="text-lg font-semibold mb-2">AI Analysis via OpenRouter</h3>
                          <div className="bg-gray-50 border-l-4 border-gray-300 p-4 mb-4">
                            <p><strong className="text-red-600">Disclaimer:</strong> This AI analysis is for informational purposes only and does not constitute medical advice. Please consult a healthcare professional for medical concerns.</p>
                          </div>
                          <div className="flex space-x-4 mb-4">
                            <button
                              onClick={analyzeWithOpenAI}
                              className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium"
                            >
                              Analyze
                            </button>
                            {analysisResult && (
                              <button
                                onClick={downloadAnalysis}
                                className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium"
                              >
                                Download analysis
                              </button>
                            )}
                          </div>
                          {analysisError && (
                            <p className="text-red-500 mb-4">{analysisError}</p>
                          )}
                          {analysisResult && (
                            <div className="bg-gray-100 p-4 rounded prose max-w-none">
                              <div dangerouslySetInnerHTML={{ __html: renderMarkdown(analysisResult) }} />
                            </div>
                          )}
                        </div>
                        <div className="overflow-x-auto">
                          <table className="w-full border-collapse border">
                            <thead>
                              <tr className="bg-gray-200">
                                <th className="border p-2">Date</th>
                                <th className="border p-2">Time</th>
                                <th className="border p-2">Duration</th>
                                <th className="border p-2">Intensity</th>
                                <th className="border p-2">Symptoms</th>
                                <th className="border p-2">Stress Situation</th>
                                <th className="border p-2">Family Interaction</th>
                                <th className="border p-2">Action</th>
                              </tr>
                            </thead>
                            <tbody>
                              {entries.map((entry, index) => (
                                <tr key={index}>
                                  <td className="border p-2">{entry.date}</td>
                                  <td className="border p-2">{entry.time}</td>
                                  <td className="border p-2">{entry.duration}</td>
                                  <td className="border p-2">{entry.intensity}</td>
                                  <td className="border p-2">{entry.symptoms}</td>
                                  <td className="border p-2">{entry.stressSituation}</td>
                                  <td className="border p-2">{entry.familyInteraction}</td>
                                  <td className="border p-2">
                                    <div className="flex space-x-2">
                                      <button
                                        onClick={() => handleShowDetails(index)}
                                        className="p-2 rounded hover:bg-gray-100 text-gray-600 hover:text-gray-800 transition-all duration-200"
                                        title="View Details"
                                      >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                      </button>
                                      <button
                                        onClick={() => handleEditEntry(index)}
                                        className="p-2 rounded hover:bg-orange-100 text-gray-600 hover:text-orange-600 transition-all duration-200"
                                        title="Edit Entry"
                                      >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                      </button>
                                      <button
                                        onClick={() => handleAdoptEntry(index)}
                                        className="p-2 rounded hover:bg-gray-100 text-gray-600 hover:text-gray-800 transition-all duration-200"
                                        title="Apply as new entry"
                                      >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                      </button>
                                      <button
                                        onClick={() => handleDelete(index)}
                                        className="p-2 rounded hover:bg-red-50 hover:text-red-600 transition-all duration-200"
                                        title="Delete Entry"
                                      >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    ) : (
                      <p>No entries available.</p>
                    )}
                  </div>
                </div>

                <div id="content-management" className="tab-content">
                  <div className="space-y-6">
                    <div className="bg-blue-50 p-4 rounded border-l-4 border-blue-400 mb-6">
                      <h2 className="text-lg font-semibold mb-2">OpenRouter API Configuration</h2>
                      <div className="flex items-center space-x-4">
                        <div className="flex-1">
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            API Key
                          </label>
                          <input
                            type="password"
                            value={apiKey}
                            onChange={handleApiKeyChange}
                            placeholder="Enter your OpenRouter API key"
                            className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          />
                        </div>
                        <div className="text-sm text-gray-600 max-w-md">
                          <p>Required for quick fill and analysis functions.</p>
                          <p>Get API key from <a href="https://openrouter.ai/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">openrouter.ai</a>.</p>
                        </div>
                      </div>
                    </div>

                    <div className="bg-gray-50 p-4 rounded">
                      <h3 className="text-lg font-semibold mb-4">Data Management</h3>
                    <div className="flex space-x-4 mb-4">
                      <button onClick={downloadCSV} className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium">Download as CSV</button>
                      <label className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium cursor-pointer">
                        Import CSV
                        <input type="file" accept=".csv" onChange={handleImport} className="hidden" />
                      </label>
                    </div>
                    </div>

                    <div className="bg-gray-100 p-4 rounded">
                      <h2 className="text-xl font-semibold mb-4">Recommendations</h2>
                      <ul className="list-disc pl-5">
                        <li>Maintain this headache diary regularly to identify patterns.</li>
                        <li>Improve sleep hygiene: Set fixed bedtime and more outdoor activity (10-11 hours of sleep per night).</li>
                        <li>Adjust diet: Temporarily reduce chocolate and cheese to test for potential triggers.</li>
                        <li>Monitor fluid intake: Ensure the child drinks about 1-1.5 liters of water per day.</li>
                        <li>Consult a pediatrician/neurologist to rule out other causes.</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

          {chatbotOpen && (
            <Chatbot
              formData={formData}
              setFormData={setFormData}
              apiKey={apiKey}
              setChatbotOpen={setChatbotOpen}
              setChatbotError={setChatbotError}
            />
          )}

          {selectedEntry && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
              <div className="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                <h3 className="text-xl font-semibold mb-4">Entry Details</h3>
                <div className="grid grid-cols-1 gap-4">
                  <div><strong>Date:</strong> {selectedEntry.date}</div>
                  <div><strong>Time:</strong> {selectedEntry.time}</div>
                  <div><strong>Duration (minutes):</strong> {selectedEntry.duration}</div>
                  <div><strong>Intensity:</strong> {selectedEntry.intensity}</div>
                  <div><strong>Symptoms:</strong> {selectedEntry.symptoms}</div>
                  <div><strong>Stress Situation:</strong> {selectedEntry.stressSituation}</div>
                  <div><strong>Family Interaction:</strong> {selectedEntry.familyInteraction}</div>
                  <div><strong>Stress Signs:</strong> {selectedEntry.stressSigns}</div>
                  <div><strong>Sleep Hours per Night:</strong> {selectedEntry.sleepHours}</div>
                  <div><strong>Sleep Quality:</strong> {selectedEntry.sleepQuality}</div>
                  <div><strong>Daily Activity:</strong> {selectedEntry.dailyActivity}</div>
                  <div><strong>Chocolate Amount:</strong> {selectedEntry.chocolateAmount}</div>
                  <div><strong>Cheese Amount:</strong> {selectedEntry.cheeseAmount}</div>
                  <div><strong>Other Foods:</strong> {selectedEntry.otherFoods}</div>
                  <div><strong>Water Intake:</strong> {selectedEntry.waterIntake}</div>
                  <div><strong>Dehydration Signs:</strong> {selectedEntry.dehydrationSigns}</div>
                  <div><strong>Evening Snacks:</strong> {selectedEntry.snacks}</div>
                  <div><strong>Meal Routine:</strong> {selectedEntry.mealRoutine}</div>
                  <div><strong>Screen Time:</strong> {selectedEntry.screenTime}</div>
                  <div><strong>Allergies/Intolerances:</strong> {selectedEntry.allergies}</div>
                  <div><strong>Medical Tests:</strong> {selectedEntry.medicalTests}</div>
                  <div><strong>Environmental Changes:</strong> {selectedEntry.environmentChanges}</div>
                </div>
                <button
                  onClick={handleCloseModal}
                  className="mt-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-3 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 font-medium"
                >
                  Close
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<HeadacheDiary />, document.getElementById('root'));
  </script>
</body>
</html>
